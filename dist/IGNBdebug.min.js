!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.IGNBdebug=t()}(this,function(){function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function i(e,t,n){return t&&r(e.prototype,t),n&&r(e,n),e}function u(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&n(e,t)}function c(e){return(c=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function n(e,t){return(n=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function a(e,t){return!t||"object"!=typeof t&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}var s={typeDecide:function(e,t){return Object.prototype.toString.call(e)==="[object ".concat(t,"]")},isFunction:function(e){return s.typeDecide(e,"Function")},isString:function(e){return s.typeDecide(e,"String")},serializeObj:function(t){var n="";return Object.keys(t).forEach(function(e){s.typeDecide(t[e],"Object")?n+="".concat(e,"=").concat(JSON.stringify(t[e])):n+="".concat(e,"=").concat(t[e],"^")}),encodeURIComponent(n.substr(0,n.length-1))},noop:function(){},now:function(){return(new Date).getTime()}},f=function(){function t(e){o(this,t),this.config={version:"1.0.0",setSystemInfo:!1,setLocation:!1,key:"",mergeReport:!0,delay:1e3,url:"",except:[/^Script error\.?/,/^Javascript error: Script error\.? on line 0/],random:1,repeat:5},this.config=Object.assign(this.config,e)}return i(t,[{key:"get",value:function(e){return this.config[e]}},{key:"set",value:function(e,t){return this.config[e]=t,this.config[e]}}]),t}(),h=function(){function e(){o(this,e),this.handlers={}}return i(e,[{key:"on",value:function(e,t){return this.handlers[e]=this.handlers[e]||[],this.handlers[e].push(t),this.handlers[e]}},{key:"off",value:function(e){this.handlers[e]&&delete this.handlers[e]}},{key:"trigger",value:function(e,t){var n=this,r=t||[],o=this.handlers[e];return!o||o.every(function(e){return!1!==e.apply(n,r)})}}]),e}(),t=function(e){function t(e){var r;return o(this,t),(r=a(this,c(t).call(this,e))).errorQueue=[],r.repeatList={},r.config=(new f).config,["log","debug","info","warn","error"].forEach(function(t,n){r[t]=function(e){return r.handleMsg(e,t,n)}}),r}return u(t,h),i(t,[{key:"repeat",value:function(e){var t=e.rowNum||"",n=e.colNum||"",r=e.msg+t+n;return this.repeatList[r]=this.repeatList[r]?this.repeatList[r]+1:1,this.repeatList[r]>this.config.repeat}},{key:"except",value:function(e){var t=this.config.except,n=!1,r=null;if(s.typeDecide(t,"Array"))for(var o=0,i=t.length;o<i;o++)if(r=t[o],s.typeDecide(r,"RegExp")&&r.test(e.msg)){n=!0;break}return n}},{key:"request",value:function(e,t,n){if(!this.config.key)throw new Error("please set key in IGNBdebug.config.key");t.key=this.config.key,wx.request({url:e,method:"POST",data:t,success:n})}},{key:"report",value:function(e){var t=this,n=this.config.mergeReport;if(0===this.errorQueue.length)return this.config.url;var r=n?this.errorQueue:[this.errorQueue.shift()];n&&(this.errorQueue=[]);var o=this.config.url,i={error:r,systemInfo:this.systemInfo,breadcrumbs:this.breadcrumbs,locationInfo:this.locationInfo,networkType:this.networkType,notifierVersion:this.config.version};return this.request(o,i,function(){e&&e.call(t),t.trigger("afterReport")}),o}},{key:"send",value:function(e){var t=this;if(this.trigger("beforeReport")){var n=e||s.noop,r=this.config.mergeReport?this.config.delay:0;setTimeout(function(){t.report(n)},r)}}},{key:"catchError",value:function(e){return!(Math.random()>=this.config.random)&&(!this.repeat(e)&&(!this.except(e)&&(this.errorQueue.push(e),this.errorQueue)))}},{key:"handleMsg",value:function(e,t,n){if(!e)return!1;var r=s.typeDecide(e,"Object")?e:{msg:e};return r.level=n,r.type=t,this.catchError(r)&&this.send(),r}}]),t}();return new(function(e){function n(e){var t;return o(this,n),(t=a(this,c(n).call(this,e))).breadcrumbs=[],t.activePage={},t.rewriteApp(),t.rewritePage(),t}return u(n,t),i(n,[{key:"rewriteApp",value:function(){var o=this,t=App,i=this;App=function(e){return["onLaunch","onShow","onHide","onError"].forEach(function(n){var r=e[n];"onLaunch"===n&&(i.getNetworkType(),i.config.setLocation&&i.getLocation(),i.config.setSystemInfo&&i.getSystemInfo()),e[n]=function(e){var t={type:"function",time:s.now(),belong:"App",method:n,path:e&&e.path,query:e&&e.query,scene:e&&e.scene};return i.pushToBreadcrumb(t),"onError"===n&&i.error({msg:e}),r&&r.call(o,e)}}),t(e)}}},{key:"rewritePage",value:function(){var n=this,e=Page;Page=function(t){return Object.keys(t).forEach(function(e){"function"==typeof t[e]&&n.recordPageFn(t,e)}),t.onReady||n.recordPageFn(t,"onReady"),t.onLoad||n.recordPageFn(t,"onLoad"),e(t)}}},{key:"getActivePage",value:function(){var e=getCurrentPages();return e.length?e[e.length-1]:{}}},{key:"pushToBreadcrumb",value:function(e){this.breadcrumbs.push(e),20<this.breadcrumbs.length&&this.breadcrumbs.shift()}},{key:"recordPageFn",value:function(e,t){var n=e[t],r=this;e[t]=function(){"onLoad"!==t&&"onShow"!==t||(r.activePage=r.getActivePage());var e={type:"function",time:s.now(),belong:"Page",method:t,route:r.activePage&&r.activePage.route,options:r.activePage&&r.activePage.options};return"onLoad"===t&&(e.args=arguments),r.methodFilter(t)&&r.pushToBreadcrumb(e),n&&n.apply(this,arguments)}}},{key:"methodFilter",value:function(e){return"onPageScroll"!==e}},{key:"getNetworkType",value:function(){var t=this;wx.getNetworkType({success:function(e){t.networkType=e.networkType}})}},{key:"getSystemInfo",value:function(){var t=this;wx.getSystemInfo({success:function(e){t.systemInfo=e}})}},{key:"getLocation",value:function(){var t=this;wx.getLocation({type:"wgs84",success:function(e){t.locationInfo=e}})}}]),n}())});
